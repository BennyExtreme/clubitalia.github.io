name: String Core Baker
run-name: ${{ github.actor }} updated a core file~ ‚öôÔ∏è
on:
  push:
    paths:
      - 'string-core/**'
  workflow_dispatch:
jobs:
  Bake-String-Data:
    runs-on: ubuntu-latest
    steps:
      - name: Sparse Checkout~ üìã
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .baked
            string-core

      - name: Fetching json files~ üìÉ
        run: |
          files=($(ls ./string-core/*.json))
          json_cnt=0
          json_array="{"
          
          # Iterate the global data.
          for file in "${files[@]}"
          do
            file_name=$(basename -- "$file" .json)

            # Append "," from the second iteration onwards.
            [[ $json_cnt -eq 0 ]] && json_cnt=$((json_cnt+1)) || json_array+=","

            # Use jq to order the values alphabetically inside each key
            json_array+="\"$file_name\":$(jq -c 'with_entries(.value |= sort)' "$file")"
          done
          
          # Iterate the sub-modules.
          files=($(ls ./string-core/sub-modules/*.json))
          for file in "${files[@]}"
          do
            sub_json_array=$json_array
            file_name=$(basename -- "$file" .json)

            # Use jq to append the json
            sub_json_array+=",\"$file_name\":$(jq -c . < "$file")}"

            mkdir -p ./.baked/string/sub-modules && touch "./.baked/string/sub-modules/${file_name}.json"
            echo $sub_json_array > "./.baked/string/sub-modules/${file_name}.json"
          done

          json_array+="}"
          mkdir -p ./.baked/string && touch ./.baked/string/global.json
          echo $json_array > ./.baked/string/global.json

      - name: Commiting changes! üì¶Ô∏è
        run: |
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git config --global user.name 'github-actions[bot]'
          git add ./.baked/*
          git commit -m 'Baked string data'
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
